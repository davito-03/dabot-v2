<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Dabot (Offline)</title>
    <meta name="description" content="Dashboard de control de Da Bot - Modo Offline">
    
    <!-- CSS Local -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/dashboard-fix.css">
    
    <!-- Fuentes locales simuladas con CSS -->
    <style>
        @import url('data:text/css;charset=utf-8,body{font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;}');
    </style>
</head>
<body class="dashboard-body" style="background-color: #1a1a1a; color: #ffffff;">
    <div id="star-background" style="display: none;"></div>
    <!-- Loading -->
    <div id="loading" class="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Cargando dashboard...</p>
        </div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <img src="/media/favicon-32x32.png" alt="Dabot" class="logo-img">
                <div class="logo-text">
                    <h1>Dabot</h1>
                    <span>Dashboard</span>
                </div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <ul class="nav-list">
                <li class="nav-item active">
                    <a href="dashboard.html" class="nav-link" data-page="dashboard">
                        <i data-feather="home"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="tickets.html" class="nav-link" data-page="tickets">
                        <i data-feather="message-circle"></i>
                        <span>Tickets</span>
                        <span class="badge" id="tickets-badge">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="moderation.html" class="nav-link" data-page="moderation">
                        <i data-feather="shield"></i>
                        <span>Moderación</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="economy.html" class="nav-link" data-page="economy">
                        <i data-feather="dollar-sign"></i>
                        <span>Economía</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="music.html" class="nav-link" data-page="music">
                        <i data-feather="music"></i>
                        <span>Música</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="voicemaster.html" class="nav-link" data-page="voicemaster">
                        <i data-feather="mic"></i>
                        <span>VoiceMaster</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="settings.html" class="nav-link" data-page="settings">
                        <i data-feather="settings"></i>
                        <span>Configuración</span>
                    </a>
                </li>
            </ul>
        </nav>

        <div class="sidebar-footer">
            <div class="user-info-sidebar">
                <img id="user-avatar" src="" alt="Usuario" class="user-avatar">
                <div class="user-details">
                    <h4 id="user-name">Cargando...</h4>
                    <p id="user-status">Conectado</p>
                </div>
            </div>
            
            <button id="logout-btn" class="btn btn-ghost btn-sm" data-tooltip="Cerrar sesión">
                <i data-feather="log-out"></i>
            </button>
        </div>
    </aside>

    <!-- Contenido principal -->
    <main class="main-content">
        <!-- Header principal -->
        <header class="dashboard-header">
            <div class="header-left">
                <button class="sidebar-toggle" id="sidebar-toggle">
                    <i data-feather="menu"></i>
                </button>
                
                <div class="breadcrumb">
                    <span class="breadcrumb-item">Dashboard</span>
                </div>
            </div>

            <div class="header-center">
                <div class="guild-selector">
                    <label for="guild-select">Servidor:</label>
                    <select id="guild-select" class="form-select">
                        <option value="">Seleccionar servidor...</option>
                    </select>
                </div>
            </div>

            <div class="header-right">
                <button id="refresh-btn" class="btn btn-ghost" data-tooltip="Actualizar">
                    <i data-feather="refresh-cw"></i>
                </button>
                
                <div class="bot-status">
                    <div id="bot-status" class="status-indicator online">
                        <i data-feather="circle"></i>
                    </div>
                    <span>Bot Online</span>
                </div>
            </div>
        </header>

        <!-- Contenido del dashboard -->
        <div class="dashboard-content">
            <!-- Error container -->
            <div id="error-container" class="error-container"></div>

            <!-- Estadísticas globales del bot -->
            <section class="stats-section">
                <h2 class="section-title">Estadísticas del Bot</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i data-feather="server"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="total-guilds">-</h3>
                            <p>Servidores</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <i data-feather="users"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="total-users">-</h3>
                            <p>Usuarios</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <i data-feather="zap"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="commands-today">-</h3>
                            <p>Comandos hoy</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <i data-feather="clock"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="uptime">-</h3>
                            <p>Tiempo activo</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Mensaje cuando no hay servidor seleccionado -->
            <div id="no-guild-selected" class="no-selection">
                <div class="no-selection-content">
                    <i data-feather="server"></i>
                    <h3>Selecciona un servidor</h3>
                    <p>Elige un servidor de la lista superior para ver sus estadísticas y configuración.</p>
                </div>
            </div>

            <!-- Secciones del servidor (ocultas por defecto) -->
            <div class="guild-sections" style="display: none;">
                <!-- Header del servidor -->
                <section id="guild-header" class="guild-header guild-section">
                    <!-- Se llenará dinámicamente -->
                </section>

                <!-- Estadísticas del servidor -->
                <section class="guild-stats guild-section">
                    <h2 class="section-title">Estadísticas del Servidor</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i data-feather="users"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="guild-members">-</h3>
                                <p>Miembros</p>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon">
                                <i data-feather="alert-triangle"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="active-warnings">-</h3>
                                <p>Warnings Activos</p>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon">
                                <i data-feather="message-circle"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="open-tickets">-</h3>
                                <p>Tickets Abiertos</p>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon">
                                <i data-feather="dollar-sign"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="total-credits">-</h3>
                                <p>Créditos Totales</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Gráficos y actividad -->
                <div class="dashboard-grid guild-section">
                    <!-- Actividad reciente -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>Actividad Reciente</h3>
                            <button class="btn btn-ghost btn-sm">
                                <i data-feather="external-link"></i>
                            </button>
                        </div>
                        
                        <div class="card-content">
                            <div id="recent-activity" class="activity-list">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>
                    </div>

                    <!-- Tickets recientes -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>Tickets Recientes</h3>
                            <a href="tickets.html" class="btn btn-ghost btn-sm">
                                <i data-feather="external-link"></i>
                            </a>
                        </div>
                        
                        <div class="card-content">
                            <div id="recent-tickets" class="tickets-list">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>
                    </div>

                    <!-- Top usuarios economía -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>Top Economía</h3>
                            <a href="economy.html" class="btn btn-ghost btn-sm">
                                <i data-feather="external-link"></i>
                            </a>
                        </div>
                        
                        <div class="card-content">
                            <div id="top-economy" class="economy-list">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>
                    </div>

                    <!-- Estado de la música -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>Reproductor de Música</h3>
                            <a href="music.html" class="btn btn-ghost btn-sm">
                                <i data-feather="external-link"></i>
                            </a>
                        </div>
                        
                        <div class="card-content">
                            <div id="music-status" class="music-info">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Acciones rápidas -->
                <section class="quick-actions guild-section">
                    <h2 class="section-title">Acciones Rápidas</h2>
                    <div class="actions-grid">
                        <a href="tickets.html" class="action-card">
                            <div class="action-icon">
                                <i data-feather="message-circle"></i>
                            </div>
                            <h3>Gestionar Tickets</h3>
                            <p>Ver y responder tickets de soporte</p>
                        </a>

                        <a href="moderation.html" class="action-card">
                            <div class="action-icon">
                                <i data-feather="shield"></i>
                            </div>
                            <h3>Moderación</h3>
                            <p>Gestionar warnings y sanciones</p>
                        </a>

                        <a href="economy.html" class="action-card">
                            <div class="action-icon">
                                <i data-feather="dollar-sign"></i>
                            </div>
                            <h3>Economía</h3>
                            <p>Ver estadísticas y gestionar créditos</p>
                        </a>

                        <a href="settings.html" class="action-card">
                            <div class="action-icon">
                                <i data-feather="settings"></i>
                            </div>
                            <h3>Configuración</h3>
                            <p>Ajustar configuración del bot</p>
                        </a>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- Scripts -->
        <script type="module">
            import { initStars } from '/assets/js/stars.js';
            import music from '/assets/js/music.js';
            initStars();
            music.init();
        </script>
        <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.28.0/dist/feather.min.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/local-auth.js"></script>
    <script src="js/dashboard-simple.js"></script>
    
    <script>
        // Inicializar iconos
        feather.replace();

        // Funciones básicas sin verificación de autenticación
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Dashboard cargado en modo simplificado');
            
            // Ocultar loading después de un momento
            setTimeout(() => {
                const loading = document.getElementById('loading');
                if (loading) {
                    loading.style.display = 'none';
                }
            }, 500);
        });

        // Cerrar sidebar al hacer click fuera en móvil
        document.addEventListener('click', (e) => {
            const sidebar = document.querySelector('.sidebar');
            const toggle = document.getElementById('sidebar-toggle');
            
            if (window.innerWidth <= 768 && 
                !sidebar.contains(e.target) && 
                !toggle.contains(e.target)) {
                sidebar.classList.remove('mobile-open');
            }
        });

        // Actualizar iconos cuando cambie el DOM
        const observer = new MutationObserver(() => {
            feather.replace();
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true
        });

        // Manejar redimensionado de ventana
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                document.querySelector('.sidebar').classList.remove('mobile-open');
            }
        });

        // Funciones para actualizar datos dinámicos
        function updateRecentActivity(activities) {
            const container = document.getElementById('recent-activity');
            if (!container || !activities || activities.length === 0) {
                container.innerHTML = '<p class="no-data">No hay actividad reciente</p>';
                return;
            }

            container.innerHTML = activities.slice(0, 5).map(activity => `
                <div class="activity-item">
                    <div class="activity-icon ${activity.type}">
                        <i data-feather="${getActivityIcon(activity.type)}"></i>
                    </div>
                    <div class="activity-content">
                        <p>${activity.message}</p>
                        <span class="activity-time">${window.DaBotUtils.formatRelativeTime(activity.timestamp)}</span>
                    </div>
                </div>
            `).join('');
            
            feather.replace();
        }

        function updateRecentTickets(tickets) {
            const container = document.getElementById('recent-tickets');
            if (!container || !tickets || tickets.length === 0) {
                container.innerHTML = '<p class="no-data">No hay tickets recientes</p>';
                return;
            }

            container.innerHTML = tickets.slice(0, 3).map(ticket => `
                <div class="ticket-item">
                    <div class="ticket-info">
                        <h4>#${ticket.id} - ${window.DaBotUtils.truncateText(ticket.subject, 30)}</h4>
                        <p>${ticket.user.username}</p>
                    </div>
                    <span class="badge badge-${ticket.status}">${getStatusText(ticket.status)}</span>
                </div>
            `).join('');
        }

        function updateTopEconomy(users) {
            const container = document.getElementById('top-economy');
            if (!container || !users || users.length === 0) {
                container.innerHTML = '<p class="no-data">No hay datos de economía</p>';
                return;
            }

            container.innerHTML = users.slice(0, 5).map((user, index) => `
                <div class="economy-item">
                    <span class="rank">#${index + 1}</span>
                    <div class="user-info">
                        <h4>${user.username}</h4>
                        <p>${window.DaBotUtils.formatNumber(user.balance)} davitos</p>
                    </div>
                </div>
            `).join('');
        }

        function updateMusicStatus(status) {
            const container = document.getElementById('music-status');
            if (!container) return;

            if (!status || !status.playing) {
                container.innerHTML = '<p class="no-data">No hay música reproduciéndose</p>';
                return;
            }

            container.innerHTML = `
                <div class="music-player">
                    <div class="music-info">
                        <h4>${window.DaBotUtils.truncateText(status.title, 40)}</h4>
                        <p>por ${status.author}</p>
                    </div>
                    <div class="music-controls">
                        <span class="music-time">${formatTime(status.position)} / ${formatTime(status.duration)}</span>
                        <div class="music-progress">
                            <div class="progress-bar" style="width: ${(status.position / status.duration) * 100}%"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Funciones auxiliares
        function getActivityIcon(type) {
            const icons = {
                'warning': 'alert-triangle',
                'ban': 'shield-off',
                'kick': 'user-x',
                'mute': 'mic-off',
                'ticket': 'message-circle',
                'economy': 'dollar-sign',
                'music': 'music'
            };
            return icons[type] || 'info';
        }

        function getStatusText(status) {
            const texts = {
                'open': 'Abierto',
                'pending': 'Pendiente',
                'closed': 'Cerrado'
            };
            return texts[status] || status;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Exponer funciones para uso del dashboard.js
        window.dashboardUI = {
            updateRecentActivity,
            updateRecentTickets,
            updateTopEconomy,
            updateMusicStatus
        };
    </script>
</body>
</html>
