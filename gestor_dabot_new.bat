@echo off
chcp 65001 > nul
setlocal enabledelayedexpansion

:: ========================================
:: DABOT V2 - GESTOR COMPLETO
:: Archivo de gesti√≥n integral del bot
:: Por davito - DaBot v2
:: ========================================

title DaBot v2 - Gestor Completo

:: Variables de configuraci√≥n
set "BOT_DIR=%~dp0"
set "BOT_SCRIPT=bot.py"
set "PYTHON_CMD=python"
set "VENV_DIR=.venv"
set "REQUIREMENTS_FILE=requirements.txt"
set "SERVICE_NAME=DaBot_v2"
set "STARTUP_DIR=%APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup"
set "AUTOSTART_SCRIPT=DaBot_v2_AutoStart.bat"

:: Colores (usando escape sequences para Windows 10+)
set "RED=[91m"
set "GREEN=[92m"
set "YELLOW=[93m"
set "BLUE=[94m"
set "MAGENTA=[95m"
set "CYAN=[96m"
set "WHITE=[97m"
set "RESET=[0m"

:MAIN_MENU
cls
echo.
echo %CYAN%‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó%RESET%
echo %CYAN%‚ïë                     ü§ñ DABOT V2 - GESTOR COMPLETO ü§ñ                 ‚ïë%RESET%
echo %CYAN%‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£%RESET%
echo %CYAN%‚ïë                                                                      ‚ïë%RESET%
echo %CYAN%‚ïë                        üìã OPCIONES PRINCIPALES                       ‚ïë%RESET%
echo %CYAN%‚ïë                                                                      ‚ïë%RESET%
echo %CYAN%‚ïë  %WHITE%üéÆ CONTROL DEL BOT:%RESET%                                              %CYAN%‚ïë%RESET%
echo %CYAN%‚ïë    %WHITE%1.%GREEN% ‚ñ∂Ô∏è  Iniciar Bot%RESET%                 %WHITE%2.%RED% ‚èπÔ∏è  Detener Bot%RESET%         %CYAN%‚ïë%RESET%
echo %CYAN%‚ïë    %WHITE%3.%YELLOW% üîÑ Reiniciar Bot%RESET%              %WHITE%4.%BLUE% üìä Ver Estado%RESET%           %CYAN%‚ïë%RESET%
echo %CYAN%‚ïë                                                                      ‚ïë%RESET%
echo %CYAN%‚ïë  %WHITE%‚öôÔ∏è  CONFIGURACI√ìN:%RESET%                                               %CYAN%‚ïë%RESET%
echo %CYAN%‚ïë    %WHITE%5.%MAGENTA% üì¶ Instalar Todo%RESET%             %WHITE%6.%CYAN% üîë Configurar Token%RESET%     %CYAN%‚ïë%RESET%
echo %CYAN%‚ïë    %WHITE%7.%YELLOW% üîß Reparar Problemas%RESET%          %WHITE%8.%BLUE% üìã Ver Logs/Errores%RESET%     %CYAN%‚ïë%RESET%
echo %CYAN%‚ïë                                                                      ‚ïë%RESET%
echo %CYAN%‚ïë  %WHITE%üèÅ AUTOARRANQUE:%RESET%                                                 %CYAN%‚ïë%RESET%
echo %CYAN%‚ïë    %WHITE%9.%GREEN% ‚úÖ Activar Autoarranque%RESET%        %WHITE%10.%RED% ‚ùå Desactivar%RESET%           %CYAN%‚ïë%RESET%
echo %CYAN%‚ïë                                                                      ‚ïë%RESET%
echo %CYAN%‚ïë  %WHITE%üõ†Ô∏è  HERRAMIENTAS:%RESET%                                                %CYAN%‚ïë%RESET%
echo %CYAN%‚ïë    %WHITE%11.%BLUE% üß™ Probar Sistema%RESET%              %WHITE%12.%GREEN% üîç Verificar Todo%RESET%       %CYAN%‚ïë%RESET%
echo %CYAN%‚ïë    %WHITE%13.%CYAN% üìÇ Abrir Carpeta%RESET%               %WHITE%14.%CYAN% üíª Abrir Terminal%RESET%       %CYAN%‚ïë%RESET%
echo %CYAN%‚ïë                                                                      ‚ïë%RESET%
echo %CYAN%‚ïë  %WHITE%üìö AYUDA:%RESET%                                                        %CYAN%‚ïë%RESET%
echo %CYAN%‚ïë    %WHITE%15.%BLUE% üìñ Ver Documentaci√≥n%RESET%           %WHITE%16.%GREEN% üÜò Ayuda Completa%RESET%      %CYAN%‚ïë%RESET%
echo %CYAN%‚ïë                                                                      ‚ïë%RESET%
echo %CYAN%‚ïë                        %WHITE%0.%RED% üö™ Salir del Gestor%RESET%                       %CYAN%‚ïë%RESET%
echo %CYAN%‚ïë                                                                      ‚ïë%RESET%
echo %CYAN%‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù%RESET%
echo.

:: Mostrar estado actual del bot
call :CHECK_BOT_STATUS
if !bot_running! equ 1 (
    echo %GREEN%üü¢ ESTADO ACTUAL: Bot funcionando correctamente%RESET%
) else (
    echo %RED%üî¥ ESTADO ACTUAL: Bot detenido%RESET%
)

:: Verificar autoarranque
call :CHECK_AUTOSTART
if !autostart_enabled! equ 1 (
    echo %GREEN%üèÅ AUTOARRANQUE: Activado (se inicia con Windows)%RESET%
) else (
    echo %YELLOW%‚ö†Ô∏è  AUTOARRANQUE: Desactivado%RESET%
)

echo.
echo %WHITE%‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó%RESET%
echo %WHITE%‚ïë  %CYAN%üí° GU√çA R√ÅPIDA:%RESET%                                                     %WHITE%‚ïë%RESET%
echo %WHITE%‚ïë    %YELLOW%‚Ä¢ Primera vez?%RESET%  %WHITE%Usa opci√≥n %MAGENTA%5%WHITE% para instalar autom√°ticamente%RESET%  %WHITE%‚ïë%RESET%
echo %WHITE%‚ïë    %YELLOW%‚Ä¢ Configurar?%RESET%   %WHITE%Usa opci√≥n %CYAN%6%WHITE% para configurar tu token%RESET%     %WHITE%‚ïë%RESET%
echo %WHITE%‚ïë    %YELLOW%‚Ä¢ ¬øProblemas?%RESET%   %WHITE%Usa opci√≥n %YELLOW%7%WHITE% para reparar autom√°ticamente%RESET% %WHITE%‚ïë%RESET%
echo %WHITE%‚ïë    %YELLOW%‚Ä¢ ¬øAutostart?%RESET%   %WHITE%Usa opci√≥n %GREEN%9%WHITE% para arranque autom√°tico%RESET%     %WHITE%‚ïë%RESET%
echo %WHITE%‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù%RESET%
echo.

set /p "choice=%CYAN%üëâ Elige una opci√≥n (0-16): %RESET%"

if "%choice%"=="1" goto START_BOT
if "%choice%"=="2" goto STOP_BOT
if "%choice%"=="3" goto RESTART_BOT
if "%choice%"=="4" goto BOT_STATUS
if "%choice%"=="5" goto INSTALL_UPDATE
if "%choice%"=="6" goto CONFIGURE_BOT
if "%choice%"=="7" goto REPAIR_DEPENDENCIES
if "%choice%"=="8" goto VIEW_LOGS
if "%choice%"=="9" goto SETUP_AUTOSTART
if "%choice%"=="10" goto DISABLE_AUTOSTART
if "%choice%"=="11" goto RUN_TESTS
if "%choice%"=="12" goto VERIFY_SYSTEM
if "%choice%"=="13" goto OPEN_FOLDER
if "%choice%"=="14" goto OPEN_CMD
if "%choice%"=="15" goto VIEW_DOCS
if "%choice%"=="16" goto SHOW_HELP
if "%choice%"=="0" goto EXIT

echo %RED%‚ùå Opci√≥n inv√°lida. Escribe un n√∫mero del 0 al 16.%RESET%
echo %YELLOW%üí° Sugerencia: Para empezar, prueba la opci√≥n 5 (Instalar Todo)%RESET%
pause
goto MAIN_MENU

:START_BOT
cls
echo %GREEN%üöÄ Iniciando DaBot v2...%RESET%
echo.

:: Verificar si ya est√° ejecut√°ndose
call :CHECK_BOT_STATUS
if !bot_running! equ 1 (
    echo %YELLOW%‚ö†Ô∏è  El bot ya est√° ejecut√°ndose%RESET%
    echo.
    pause
    goto MAIN_MENU
)

:: Verificar Python
call :CHECK_PYTHON
if !python_ok! neq 1 (
    echo %RED%‚ùå Python no est√° disponible%RESET%
    echo %BLUE%üí° Usa la opci√≥n 5 para instalar autom√°ticamente%RESET%
    pause
    goto MAIN_MENU
)

:: Verificar token
call :CHECK_TOKEN
if !token_ok! neq 1 (
    echo %RED%‚ùå Token de Discord no configurado%RESET%
    echo %BLUE%üí° Usa la opci√≥n 6 para configurar el token%RESET%
    pause
    goto MAIN_MENU
)

:: Verificar archivo bot.py
if not exist "%BOT_SCRIPT%" (
    echo %RED%‚ùå Archivo bot.py no encontrado%RESET%
    pause
    goto MAIN_MENU
)

echo %GREEN%‚úÖ Iniciando bot...%RESET%
start "DaBot v2" %PYTHON_CMD% "%BOT_SCRIPT%"

timeout /t 3 /nobreak > nul

call :CHECK_BOT_STATUS
if !bot_running! equ 1 (
    echo %GREEN%‚úÖ Bot iniciado correctamente%RESET%
) else (
    echo %RED%‚ùå Error al iniciar el bot%RESET%
    echo %BLUE%üí° Usa la opci√≥n 8 para ver los logs de error%RESET%
)

echo.
pause
goto MAIN_MENU

:STOP_BOT
cls
echo %RED%‚èπÔ∏è  Deteniendo DaBot v2...%RESET%
echo.

:: Matar procesos del bot
taskkill /f /im python.exe /fi "WINDOWTITLE eq DaBot v2" > nul 2>&1
taskkill /f /im py.exe /fi "WINDOWTITLE eq DaBot v2" > nul 2>&1

:: M√©todo alternativo: buscar por comando
for /f "tokens=2" %%i in ('tasklist /fi "imagename eq python.exe" /fo csv ^| findstr "bot.py"') do (
    taskkill /f /pid %%i > nul 2>&1
)

timeout /t 2 /nobreak > nul

call :CHECK_BOT_STATUS
if !bot_running! equ 0 (
    echo %GREEN%‚úÖ Bot detenido correctamente%RESET%
) else (
    echo %YELLOW%‚ö†Ô∏è  El bot podr√≠a seguir ejecut√°ndose%RESET%
    echo %CYAN%üí° Verifica el administrador de tareas si es necesario%RESET%
)

echo.
pause
goto MAIN_MENU

:RESTART_BOT
cls
echo %YELLOW%üîÑ Reiniciando DaBot v2...%RESET%
echo.

call :STOP_BOT_SILENT
timeout /t 3 /nobreak > nul
goto START_BOT

:BOT_STATUS
cls
echo %BLUE%üìä Estado del Sistema - DaBot v2%RESET%
echo %CYAN%‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê%RESET%
echo.

:: Estado del bot
echo %WHITE%ü§ñ Estado del Bot:%RESET%
call :CHECK_BOT_STATUS
if !bot_running! equ 1 (
    echo %GREEN%   ‚úÖ Funcionando%RESET%
    for /f "tokens=2" %%i in ('tasklist /fi "imagename eq python.exe" /fo csv ^| findstr "bot.py"') do (
        echo %CYAN%   üìù PID: %%i%RESET%
    )
) else (
    echo %RED%   ‚ùå Detenido%RESET%
)

echo.

:: Estado de Python
echo %WHITE%üêç Python:%RESET%
call :CHECK_PYTHON
if !python_ok! equ 1 (
    for /f "tokens=*" %%i in ('%PYTHON_CMD% --version 2^>^&1') do echo %GREEN%   ‚úÖ %%i%RESET%
) else (
    echo %RED%   ‚ùå No encontrado%RESET%
)

echo.

:: Estado del token
call :CHECK_TOKEN
echo %WHITE%üîë Token de Discord:%RESET%
if !token_ok! equ 1 (
    echo %GREEN%   ‚úÖ Configurado%RESET%
) else (
    echo %RED%   ‚ùå No configurado%RESET%
)

echo.

:: Estado del autoarranque
echo %WHITE%üèÅ Autoarranque:%RESET%
call :CHECK_AUTOSTART
if !autostart_enabled! equ 1 (
    echo %GREEN%   ‚úÖ Activado%RESET%
) else (
    echo %YELLOW%   ‚ö†Ô∏è  Desactivado%RESET%
)

echo.

:: Informaci√≥n adicional
echo %WHITE%üìÇ Directorio:%RESET% %CYAN%!BOT_DIR!%RESET%
echo %WHITE%‚è∞ Fecha/Hora:%RESET% %CYAN%!date! !time!%RESET%

echo.
pause
goto MAIN_MENU

:: Continuar con el resto de funciones...
:INSTALL_UPDATE
cls
echo %MAGENTA%üì¶ Instalaci√≥n y Actualizaci√≥n - DaBot v2%RESET%
echo.
echo %BLUE%üîÑ Instalando dependencias...%RESET%
%PYTHON_CMD% -m pip install --upgrade pip
if exist "%REQUIREMENTS_FILE%" (
    %PYTHON_CMD% -m pip install -r "%REQUIREMENTS_FILE%"
) else (
    echo %YELLOW%‚ö†Ô∏è  Archivo requirements.txt no encontrado%RESET%
    echo %BLUE%üì¶ Instalando dependencias b√°sicas...%RESET%
    %PYTHON_CMD% -m pip install nextcord aiohttp python-dotenv
)

:: Crear archivo .env si no existe
if not exist ".env" (
    echo %BLUE%üìÑ Creando archivo .env...%RESET%
    echo DISCORD_TOKEN=TU_TOKEN_AQUI > .env
    echo PREFIX=! >> .env
    echo DAILY_CHANNEL_ID= >> .env
)

echo %GREEN%‚úÖ Instalaci√≥n completada%RESET%
pause
goto MAIN_MENU

:CONFIGURE_BOT
cls
echo %CYAN%üîß Configuraci√≥n - DaBot v2%RESET%
echo.
pause
goto MAIN_MENU

:EXIT
cls
echo.
echo %GREEN%üëã Gracias por usar DaBot v2%RESET%
echo %CYAN%ü§ñ ¬°Hasta la pr√≥xima!%RESET%
echo.
timeout /t 2 /nobreak > nul
exit

:: ========================================
:: FUNCIONES AUXILIARES
:: ========================================

:CHECK_BOT_STATUS
set "bot_running=0"
for /f %%i in ('tasklist /fi "imagename eq python.exe" 2^>nul ^| findstr /i "python.exe" ^| find /c /v ""') do (
    if %%i gtr 0 (
        for /f "tokens=*" %%j in ('wmic process where "name='python.exe'" get commandline /value 2^>nul ^| findstr "CommandLine" ^| findstr "bot.py"') do (
            set "bot_running=1"
        )
    )
)
exit /b

:CHECK_PYTHON
set "python_ok=0"
%PYTHON_CMD% --version > nul 2>&1
if errorlevel 0 set "python_ok=1"
exit /b

:CHECK_TOKEN
set "token_ok=0"
if exist ".env" (
    for /f "usebackq tokens=2 delims==" %%a in (".env") do (
        if not "%%a"=="TU_TOKEN_AQUI" if not "%%a"=="" (
            set "token_ok=1"
        )
    )
)
exit /b

:CHECK_AUTOSTART
set "autostart_enabled=0"
if exist "%STARTUP_DIR%\%AUTOSTART_SCRIPT%" set "autostart_enabled=1"
exit /b

:STOP_BOT_SILENT
taskkill /f /im python.exe /fi "WINDOWTITLE eq DaBot v2" > nul 2>&1
taskkill /f /im py.exe /fi "WINDOWTITLE eq DaBot v2" > nul 2>&1
for /f "tokens=2" %%i in ('tasklist /fi "imagename eq python.exe" /fo csv 2^>nul ^| findstr "bot.py"') do (
    taskkill /f /pid %%i > nul 2>&1
)
exit /b
